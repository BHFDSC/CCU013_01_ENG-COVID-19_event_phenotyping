---
title: 'Supplementary Table 1: Data source counts'
author: 'Chris Tomlinson'
date: 'Knitted on `r date()`'

output:
  html_document:
    df_print: paged
---


**Description** 

This notebook extracts the unique `person_id_deids` for each combination of `covid_phenotype` (`event`) and `source` from `ccu013_covid_trajectory`. For each `event` it then produces counts of `ids` and `unique(ids)` from each `source`.

> Number of individuals identified from each data source stratified by COVID-19 event and as total individuals across all data sources. Date ranges shown for all included data sources after filtering as per cohort definition (see Figure 1).

  
**Project(s)** CCU013

**Paper** Characterising COVID-19 related events in a nationwide electronic health record cohort of 55.9 million people in England
 
**Author(s)** Chris Tomlinson
 
**Reviewer(s)** 
 
**Date last updated** 2021-06-16
 
**Date last reviewed** UNREVIEWED
 
**Date last run** `r date()`
 
**Data input**  
* `ccu013_covid_trajectory_cohort_paper`


**Data output**  
* Self-contained as the knitted `.html` file from this notebook  
* `.Rmd` for sharing on `GitHub`  

**Software and versions** `SQL`, `R`
 
**Packages and versions**
```{r config}
library(dplyr)
library(tidyr)
library(magrittr)

warning("Requires authenticated connection to Spark saved as 'con'. \n
        Will attempt to load but if running as another user need to configure connection manually.")
source("/mnt/efs/c.tomlinson/dbConnect.R")
```
# Paper cohort numbers
```{r}
phenos = dbGetQuery(con, "SELECT distinct covid_phenotype
                    FROM dars_nic_391419_j3w9t_collab.ccu013_covid_trajectory_paper_cohort")

sources = dbGetQuery(con, "SELECT distinct source
                    FROM dars_nic_391419_j3w9t_collab.ccu013_covid_trajectory_paper_cohort")

counts = data.frame(
  event = character(),
  source = character(),
  individuals = integer(),
  observations = integer()
)

for (p in 1:nrow(phenos)){
  pheno = phenos$covid_phenotype[p]
  for (s in 1: nrow(sources)){
    source = sources$source[s]
    
    sql = paste0("SELECT ",
                "\'", pheno, "\' as event, ",
                "\'", source, "\' as source, ",
                "COUNT(*) as observations, COUNT(distinct person_id_deid) as individuals ",
                "FROM dars_nic_391419_j3w9t_collab.ccu013_covid_trajectory_paper_cohort WHERE ",
                "covid_phenotype = \'", pheno, "\' AND ",
                "source = \'", source, "\'")
  counts = dbGetQuery(con, sql) %>% 
    rbind.data.frame(counts, .)
  }
}

counts
```
## Pivot & format
Just individuals for this output, using observations gets too confusing according to comments
```{r}
counts %>% 
  select(-observations) %>% 
  arrange(event, source) %>% 
  pivot_wider(names_from = source, 
              values_from = individuals)
```

# Dates
We expect this that should follow the study period dates, given that these have been chosen to represent a common cut-off date across all data sources:
```{r}
phenos = dbGetQuery(con, "SELECT distinct covid_phenotype
                    FROM dars_nic_391419_j3w9t_collab.ccu013_covid_trajectory_paper_cohort")

sources = dbGetQuery(con, "SELECT distinct source
                    FROM dars_nic_391419_j3w9t_collab.ccu013_covid_trajectory_paper_cohort")

dates = data.frame(
  event = character(),
  source = character(),
  min_date = integer(),
  max_date = integer()
)

for (s in 1: nrow(sources)){
  source = sources$source[s]
  
  sql = paste0("SELECT ",
              "'dates' as event, ",
              "\'", source, "\' as source, ",
              "MIN(date) as min_date, MAX(date) as max_date ",
              "FROM dars_nic_391419_j3w9t_collab.ccu013_covid_trajectory_paper_cohort WHERE ",
              "source = \'", source, "\'")
dates = dbGetQuery(con, sql) %>% 
  rbind.data.frame(dates, .)
}

dates
```

## Pivot & format
### `min(date)`
```{r}
dates %>% 
  select(-max_date) %>% 
  arrange(event, source) %>% 
  pivot_wider(names_from = source, 
              values_from = min_date)
```
### `max(date)`
```{r}
dates %>% 
  select(-min_date) %>% 
  arrange(event, source) %>% 
  pivot_wider(names_from = source, 
              values_from = max_date)
```